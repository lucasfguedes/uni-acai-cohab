<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="admin/css_adm/rotas_de_entregas.css">
    <link rel="icon" href="assets/img/logo.png" type="image/x-icon">
    <link rel="shortcut icon" href="assets/img/logo.png" type="image/x-icon">
    <title>Uni Açaí - Cohab</title>
</head>
<body>
    <header>
        <h1>Administração</h1>
        <div class="user-info">
            <img src="img_adm/icons8-macho-de-configurações-de-admin-48.png" alt="">
        </div>
    </header>
    <div class="container">
        <div class="sidebar">
            <h2>Menu</h2>
            <ul>
                <li><a href="adm.html" style="color: white; text-decoration: none;">Gerenciar Pedidos</a></li>
                <li><a href="troca_de_preços.html" style="color: white; text-decoration: none;">Trocar Preços</a></li>
                <li><a href="rotas_de_entregas.html" style="color: white; text-decoration: none;">Rotas de Entrega</a></li>
                <li><a href="usuarios.html" style="color: white; text-decoration: none;">Ver Usuários</a></li>
                <li><a href="produtos.html" style="color: white; text-decoration: none;">produtos</a></li>
            </ul>
        </div>
    <div class="main-content">

        <label>Endereço do Cliente:</label>
        <input type="text" id="enderecoCliente" placeholder="Digite o endereço">
        
        <label>Taxa por KM (R$):</label>
        <input type="number" id="taxaPorKm" value="2.00" step="0.10">
        
        <button onclick="calcularEntrega()">Calcular Entrega</button>
        
        <p id="info"></p>
    
        <script>
            const apiKey = "pk.0dabca139f61b2c9283fd4f9a9d215bb"; // Substitua com sua chave da LocationIQ
            const loja = { lat: -22.1096, lng: -51.4302}; // Localização da loja (exemplo: Presidente Prudente)
    
            async function calcularEntrega() {
                const enderecoCliente = document.getElementById("enderecoCliente").value + ", Presidente Prudente, São Paulo, Brasil";
                const taxaPorKm = parseFloat(document.getElementById("taxaPorKm").value);
    
                try {
                    // 1️⃣ Obter coordenadas do endereço do cliente usando a API de Geocodificação da LocationIQ
                    const geocodeResponse = await fetch(`https://eu1.locationiq.com/v1/search.php?key=${apiKey}&q=${encodeURIComponent(enderecoCliente)}&format=json`);
                    const geocodeData = await geocodeResponse.json();
    
                    if (!geocodeData || geocodeData.length === 0) {
                        alert("Endereço não encontrado! Tente incluir cidade e estado.");
                        return;
                    }
    
                    // Pegando as coordenadas corretamente
                    const lng = parseFloat(geocodeData[0].lon);
                    const lat = parseFloat(geocodeData[0].lat);
                    const cliente = { lat, lng };
    
                    // Verificação de depuração
                    console.log("Coordenadas do Cliente:", cliente);
    
                    // 2️⃣ Obter a distância entre a loja e o cliente usando a API de Direções da LocationIQ
                    const directionsResponse = await fetch(`https://eu1.locationiq.com/v1/directions/driving/${loja.lng},${loja.lat};${cliente.lng},${cliente.lat}?key=${apiKey}&alternatives=false&overview=false&format=json`);
                    const directionsData = await directionsResponse.json();
    
                    if (directionsData.routes && directionsData.routes[0] && directionsData.routes[0].summary) {
                        // Calcular a distância em quilômetros
                        const distancia = directionsData.routes[0].summary.distance / 1000; // Converter metros para km
                        const taxaEntrega = distancia * taxaPorKm;
    
                        // Exibir a informação no HTML
                        document.getElementById("info").innerHTML = `Distância: ${distancia.toFixed(2)} km<br> Taxa de Entrega: R$ ${taxaEntrega.toFixed(2)}`;
                    } else {
                        alert("Não foi possível calcular a distância da rota.");
                    }
                } catch (error) {
                    console.error("Erro:", error);
                    alert("Erro ao calcular a entrega! Verifique a API e tente novamente.");
                }
            }
        </script>
    </div>    

</body>
</html>
